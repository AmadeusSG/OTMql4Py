<!DOCTYPE html>
<html>
<!-- This file is automatically generated: do not edit. -->
<head>
<title>Usage</title>
<meta charset="utf-8">
</head>
<body>
<!-- <h1>Usage</h1> -->
<h4>Initialization Code</h4>

<p>The initialization code <tt>iPyInit</tt> in <tt>MQL4/Include/OTMql4/OTPy27.mqh</tt><br />
initializes the Python environment. This should be called from your<br />
<tt>OnInit()</tt> function. It is safe to call it a second time; subsequent<br />
calls will just be ignored.</p>

<p>It has an integer return value, and should return 0. <br />
A return value of -1 is a panic: remove the expert if it requires Python.</p>

<p>It calls the compiled <tt>PyInitialize()</tt> and then imports some<br />
standard system modules. Then it prepends the <tt>sys.path</tt> with the<br />
directory <tt>MQL4/Python</tt>, which should have been created when you<br />
installed <tt>OTMql4Py</tt>.  In that directory should be a (possibly<br />
empty) file <tt>__init__.py</tt>, so that you can import modules found in<br />
that directory into Python.</p>

<p>The intialization code will import the module <tt>OTMql427</tt> found in<br />
that directory to give some added functionality. If it can't import<br />
the module <tt>OTMql427</tt> it will signal a panic by returning -1: you<br />
should fix the problem before going any futher.</p>

<h4>Global Variables</h4>

<p>The <tt>iPyInit</tt> initialization creates a temporary global veriable<br />
called <tt>fPythonUsers</tt> and increments it by one each time it is<br />
called.  <tt>vPyDeInit</tt> decrements it by one each time it is called,<br />
and if <tt>fPythonUsers</tt> is zero, then it calls<br />
<tt>OTMql427.vPyDeInit</tt> to unload the Python interpreter.<br />
<tt>fPythonUsers</tt> should always be equal to the number of charts and<br />
scripts Python is being used on. Unfortunately, if your recompile your<br />
expert while Python is loaded, then Mt4 will deinit your expert and<br />
re-init the expert. If you only had one chart using Python<br />
(fPythonUsers=1), then this will unload Python when Mt4 deinits the<br />
expert, and when Mt4 re-inits the Python, it will fail to initialize<br />
the <tt>py27.dll</tt> properly. If Mt4 <tt>OnInit</tt> had a required<br />
<tt>reason</tt> argument the way <tt>OnDeinit</tt> does, we could work<br />
around this, but it doesn't. Suggestions welcome...</p>

<p>The <tt>iPyInit</tt> initialization also creates a persistent global<br />
veriable called "fDebugLevel" which is used by the logging code, and<br />
it ranges from 0 to 5: 0 : quiet, 1 : +errors, 2 : +warnings, 3 =<br />
+info, 4 : +debug, 5 : +trace.</p>

<h4>Added Python Functionality</h4>

<p>In many cases, you should use <tt>uPySafeEval</tt> to evaluate a python<br />
expression that will evaluate to a string and return its value. It calls<br />
<tt>OTMql427.sPySafeEval</tt> in Python which wraps the code to be evaluated<br />
in a <tt>try:/except:</tt> clause and catches the error. If there's an error,<br />
the error is returned as a string, prepended with <tt>ERROR: </tt>.</p>

<p>In the caller you should have something like:</p>
<pre>
    if (StringFind(uSource, "ERROR:", 0) == 0) {
      Print("Error in Python evaluating: " + uSource + "\n" + res);
      &lt;do something as a result of the failure&gt;
    }
</pre></body>
</html>
